<script>
import router from '../router'
import DateSelector from '../components/templates/DateSelector.vue'
import CheckBoxes from '../components/templates/CheckBoxes.vue'
import InputBar from '../components/templates/InputBars.vue'
import { useAuthStore } from '@/stores/counter'
import { createClient } from '@supabase/supabase-js'
const supabaseUrl = 'https://tzithwsneecztaewiwhj.supabase.co'
const supabaseKey =
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6aXRod3NuZWVjenRhZXdpd2hqIiwicm9sZSI6ImFub24iLCJpYXQiOjE2ODM2Mzk5MjksImV4cCI6MTk5OTIxNTkyOX0.YeSE7Cuk2UX5jD6haxAnmM_-RdlssSRtowQH9ejl_1w'
const supabase = createClient(supabaseUrl, supabaseKey)
export default {
  components: { DateSelector, CheckBoxes, InputBar },
  data() {
    return {
      date: '',
      petGender: '',
      time_called: new Date(),
      petBreed: '',
      sitterGender: '',
      pet: '',
      toDo: '',
      rawToDo: '',
      user: useAuthStore(),
      user_id: ''
    }
  },
  methods: {
    onMounted: async function () {
      this.checkUser()
      this.user_id = await this.user.currentUser
    },
    checkUser: function () {
      if (useAuthStore().currentUser === null) {
        window.location.href = 'loginpage'
      }
    },
    submitted: async function () {
      let pet = this.checkPet(this.pet)
      const { data, error } = await supabase.from(pet).insert([
        {
          primary_key: Math.random(),
          customer_id: this.user_id,
          time_called: this.time_called,
          appointed_time: this.date,
          pet_gender: this.petGender,
          todo_list: this.toDo,
          pet_breed: this.petBreed,
          preference_sitter_gender: this.sitterGender,
          pet_type: this.pet
        }
      ])
      console.log(error)
      if (error !== null) {
        router.push('error')
      } else {
        router.push('success')
      }
    },
    genders: function (sitterPreference, petGender) {
      this.petGender = petGender
      this.sitterGender = sitterPreference
    },
    dates: function (date) {
      this.date = date.toString()
    },
    petSpecies: function (species) {
      this.pet = species
    },
    tasks: function (tasks) {
      let array = tasks.split(',')
      this.rawToDo = tasks
      this.toDo = array
    },
    breed: function (breed) {
      this.petBreed = breed
    },
    checkPet: function (pet) {
      if (pet === 'Dog') {
        return 'DogSitters'
      } else if (pet === 'Cat') {
        return 'CatSitters'
      } else {
        return 'error'
      }
    }
  },
  mounted() {
    this.onMounted()
  }
}
</script>

<template>
  <div>
    <div class="main">
      <div class="header">
        <h1>Make An Appointment</h1>
      </div>

      <div class="requestCreator">
        <div class="row-1">
          <div class="dates">
            <DateSelector @updateDate="dates" />
          </div>

          <div class="checkboxes">
            <CheckBoxes @updateGenders="genders" @updatePets="petSpecies" />
          </div>
        </div>

        <div class="inputBar">
          <InputBar @updateTasks="tasks" @updateBreed="breed" />
        </div>

        <div class="submit">
          <button class="submit" v-on:click="submitted">Submit</button>
        </div>
      </div>
      <br />

      <div class="preview">
        <h2>This is what we see:</h2>
        <div class="card">
          <div class="date">
            <h3>{{ date }}</h3>
          </div>

          <div class="pet">
            <h3>Pet Species: {{ pet }}</h3>
            <h3>Pet Breed: {{ petBreed }}</h3>
          </div>

          <div class="genders">
            <h3 class="petGender">Pet Gender: {{ petGender }}</h3>
            <h3 class="sitterGender">Sitter Gender Preference: {{ sitterGender }}</h3>
          </div>

          <div class="tasks">
            <p class="toDo">To Do List: {{ rawToDo }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<style scoped>
@import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;1,400;1,600;1,900&display=swap');
.header {
  margin-bottom: 4.5rem;
}

h1 {
  font-family: 'Playfair Display', serif;
  font-weight: 400;
  text-align: center;
}

.row-1 {
  display: flex;
  flex-direction: row;
  justify-content: space-around;
}

.inputBar {
  width: 30rem;
}
</style>
